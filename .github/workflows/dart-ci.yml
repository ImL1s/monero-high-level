# Monero Dart CI/CD
# 此 workflow 適用於 Dart/Flutter (monero-dart) 專案

name: Dart CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ─────────────────────────────────────────
  # 1. Analyze & Format
  # ─────────────────────────────────────────
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - name: Install dependencies
        run: dart pub get
      - name: Check formatting
        run: dart format --set-exit-if-changed .
      - name: Analyze
        run: dart analyze --fatal-infos

  # ─────────────────────────────────────────
  # 2. Unit Tests (VM)
  # ─────────────────────────────────────────
  test-vm:
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - run: dart pub get
      - name: Run VM Tests
        run: dart test --platform vm --coverage coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info

  # ─────────────────────────────────────────
  # 3. Web Tests (Chrome headless)
  # ─────────────────────────────────────────
  test-web:
    runs-on: ubuntu-latest
    needs: [analyze]
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - run: dart pub get
      - name: Run Web Tests
        run: dart test --platform chrome

  # ─────────────────────────────────────────
  # 4. Flutter Integration (optional)
  # ─────────────────────────────────────────
  flutter-build:
    runs-on: ubuntu-latest
    needs: [test-vm]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: flutter pub get
      - run: flutter build apk --debug

  # ─────────────────────────────────────────
  # 5. Vector Conformance (C1–C4)
  # ─────────────────────────────────────────
  conformance:
    runs-on: ubuntu-latest
    needs: [test-vm]
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - run: dart pub get
      - name: Run Conformance Tests
        run: dart test test/conformance/ --reporter expanded

  # ─────────────────────────────────────────
  # 6. Publish to pub.dev (on tag)
  # ─────────────────────────────────────────
  publish:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [conformance]
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      - run: dart pub get
      - name: Dry-run publish
        run: dart pub publish --dry-run
      # 實際發佈需設定 PUB_CREDENTIALS secret 或使用 dart pub token
